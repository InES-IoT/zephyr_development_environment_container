\input{common.tex}

\begin{document}

\puttitle{}

\section{Introduction}

\newpage

\section{Using the Container with WSL2}

Install the following programs.

\begin{itemize}
  \item \textbf{Windows Terminal (\href{https://aka.ms/terminal}{Download})}
  \item \textbf{J-Link Software and Documentation pack
          (\href{https://www.segger.com/downloads/jlink/JLink_Windows_x86_64.exe}{Download})}

        Tick the \emph{Install USB Driver for J-Link (requires admin rights)} checkbox
        during installation.
\end{itemize}

The container can be imported and used as a WSL2 distro.

\begin{itemize}
\item Open a terminal in the lab folder.
\item Ensure that WSL is installed.
% '--no-distribution' windows 11 only?
% winget install "Windows Subsystem for Linux"
\begin{lstlisting}
wsl --install --no-distribution
\end{lstlisting}
\item Create a folder for the distro and import it.
\begin{lstlisting}
mkdir wslDistroStorage\zephyr
wsl --import zephyr wslDistroStorage\zephyr @\ttfamily\imagename{}@_wsl.tar.gz
\end{lstlisting}
\item Open a shell inside the distro.
\begin{lstlisting}
wsl -d zephyr
\end{lstlisting}
\end{itemize}

\begin{infobox}
  In case you get a
  \emph{CreateProcessParseCommon:789: Failed to translate D:\textbackslash}
  error the file system might not be available from within WSL.
  Run the following command to list the available file systems.

  \cmdinwsl{ls /mnt}

  You can try mounting the missing file system (\mono{D:\\} in this case) with
  the following commands.

  \cmdinwsl{mkdir /mnt/d}

  \cmdinwsl{mount -t drvfs D: /mnt/d}
\end{infobox}

\newpage

\section{Using the Container with a Container Runtime}

\begin{itemize}
\item Install a container runtime (e.g. \emph{podman} or \emph{docker}).

\item Load the Image

\mono{podman load --input} {\ttfamily\imagename{}}\mono{.tar.gz}

\item Start Shell in Container

\begin{lstlisting}
podman run --rm -it --network="host" \
  -v /path/to/project:/root/dev \
  @\ttfamily\imagename{}@
\end{lstlisting}
\end{itemize}

\newpage

\section{Using the Container}

\subsection{Build Sample}

\mono{cd ~/zephyrproject/zephyr/samples/basic/blinky/}

\mono{west build --pristine --board stm32f429i_disc1}

\begin{infobox}
  Append the \mono{--build-dir /tmp/build} argument if you mounted a drive from
  the Windows host. This will speed up the build process as accessing the
  Windows file system from the WSL is slow.

  \mono{west build --pristine --board stm32f429i_disc1 --build-dir /tmp/build}

  This argument will then also be needed when running \mono{west flash}.
\end{infobox}

\subsection{Flash Sample}

To flash from within the WSL the J-Link Remote Server is used. Run the following
command in a PowerShell to get the IP of the WSL network adapter.

\cmdinwsl{grep nameserver /etc/resolv.conf}

Start the \emph{J-Link Remote Server}

\begin{infobox}
  If the J-Link Remote Server shows an error try using a different port.
\end{infobox}

run the following command to flash the board.

\mono{west -v flash --runner jlink --tool-opt='-ip 172.21.160.1:19020'}

\begin{infobox}
  If you get a \emph{FAILED: Can not connect to J-Link via TCP/IP} error try
  adding a firewall rule that allows inbound connections on the WSL network
  adapter. To do that run the following command in an admin PowerShell.

  \begin{lstlisting}
New-NetFirewallRule -DisplayName "WSL" -Direction Inbound `
 -InterfaceAlias "vEthernet (WSL)" -Action Allow
  \end{lstlisting}

  Firewall rules can also be managed by running \mono{wf.msc} in a PowerShell.
\end{infobox}

\newpage

\newgeometry{margin=1cm,bottom=2cm}
\fancyfoot{}

\appendix

\section{Containerfile}\label{containerfile}
\lstinputlisting[basicstyle=\ttfamily\footnotesize]{../Containerfile}

\end{document}

% Local Variables:
% TeX-output-dir: "build"
% TeX-master: t
% End:
